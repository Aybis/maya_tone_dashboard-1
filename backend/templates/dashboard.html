<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maya-Tone Jira Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.8.0/Recharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { 
          Menu, 
          X, 
          Plus, 
          Home, 
          MessageSquare, 
          Layout, 
          ChevronDown, 
          ChevronRight,
          Send,
          User,
          Calendar,
          BarChart3,
          Clock,
          AlertCircle,
          CheckCircle,
          XCircle,
          Play,
          Loader
        } = lucide;

        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = Recharts;

        // API service functions
        const api = {
          getDashboardStats: async () => {
            const response = await fetch('/api/dashboard-stats');
            return await response.json();
          },
          
          processQuery: async (query, context = null) => {
            const response = await fetch('/query', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ query, context }),
            });
            return await response.json();
          },

          healthCheck: async () => {
            const response = await fetch('/health');
            return await response.json();
          }
        };

        // Main App Component
        function MayaToneDashboard() {
          const [currentPage, setCurrentPage] = useState('dashboard');
          const [isSidebarOpen, setIsSidebarOpen] = useState(false);
          const [isHistoryOpen, setIsHistoryOpen] = useState(true);
          const [chartFilter, setChartFilter] = useState('Monthly');
          const [currentChatId, setCurrentChatId] = useState('new');
          const [chatMessages, setChatMessages] = useState([]);
          const [newMessage, setNewMessage] = useState('');
          const [dashboardData, setDashboardData] = useState(null);
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState(null);
          const [chatContext, setChatContext] = useState(null);

          // Chat history stored in state
          const [chatHistory, setChatHistory] = useState([]);

          // Fetch dashboard data from API
          useEffect(() => {
            const fetchDashboardData = async () => {
              try {
                setLoading(true);
                const data = await api.getDashboardStats();
                setDashboardData(data);
                setError(null);
              } catch (err) {
                setError('Failed to load dashboard data');
                console.error('Dashboard data error:', err);
              } finally {
                setLoading(false);
              }
            };

            if (currentPage === 'dashboard') {
              fetchDashboardData();
            }
          }, [currentPage]);

          // Initialize chat when starting new chat
          useEffect(() => {
            if (currentChatId === 'new' && chatMessages.length === 0) {
              setChatMessages([{
                id: '1',
                type: 'ai',
                content: "Hello! I'm Maya-Tone, your Jira AI assistant. I can help you search for tickets, analyze your workload, and provide insights about your projects. What would you like to know?",
                timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
              }]);
            }
          }, [currentChatId, chatMessages.length]);

          // Handle navigation
          const handleNavigation = (page, chatId = null) => {
            setCurrentPage(page);
            if (chatId && chatId !== currentChatId) {
              setCurrentChatId(chatId);
              // In a real app, you'd load chat history from storage/API
              const savedChat = localStorage.getItem(`chat_${chatId}`);
              if (savedChat) {
                setChatMessages(JSON.parse(savedChat));
              }
            }
            setIsSidebarOpen(false);
          };

          // Handle new chat
          const handleNewChat = () => {
            const newChatId = `chat_${Date.now()}`;
            setCurrentChatId(newChatId);
            setChatMessages([]);
            setChatContext(null);
            setCurrentPage('chat');
            setIsSidebarOpen(false);
            
            // Add to chat history
            const newChatEntry = {
              id: newChatId,
              date: new Date().toISOString().split('T')[0],
              title: `Chat ${new Date().toISOString().split('T')[0]}`
            };
            setChatHistory(prev => [newChatEntry, ...prev]);
          };

          // Handle send message
          const handleSendMessage = async (e) => {
            e.preventDefault();
            if (!newMessage.trim()) return;

            const userMessage = {
              id: Date.now().toString(),
              type: 'user',
              content: newMessage,
              timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            };

            // Add user message immediately
            setChatMessages(prev => [...prev, userMessage]);
            const query = newMessage;
            setNewMessage('');

            // Add loading message
            const loadingMessage = {
              id: (Date.now() + 1).toString(),
              type: 'ai',
              content: 'Processing your request...',
              timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
              loading: true
            };
            setChatMessages(prev => [...prev, loadingMessage]);

            try {
              // Process query with API
              const result = await api.processQuery(query, chatContext);
              
              // Remove loading message and add real response
              setChatMessages(prev => {
                const withoutLoading = prev.filter(msg => !msg.loading);
                
                let responseContent = result.description || 'Here are your results:';
                if (result.tickets && result.tickets.length > 0) {
                  responseContent += `\n\nFound ${result.tickets.length} tickets:\n\n`;
                  result.tickets.forEach(ticket => {
                    responseContent += `â€¢ **${ticket.key}**: ${ticket.summary}\n  Status: ${ticket.status} | Assignee: ${ticket.assignee}\n\n`;
                  });
                } else if (result.tickets && result.tickets.length === 0) {
                  responseContent += '\n\nNo tickets found matching your criteria.';
                }

                if (result.error) {
                  responseContent = `Sorry, I encountered an error: ${result.error}`;
                }

                const aiMessage = {
                  id: (Date.now() + 2).toString(),
                  type: 'ai',
                  content: responseContent,
                  timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                  tickets: result.tickets,
                  jql: result.jql
                };
                
                return [...withoutLoading, aiMessage];
              });

              // Update context for follow-up queries
              if (result.context) {
                setChatContext(result.context);
              }

            } catch (error) {
              // Remove loading message and show error
              setChatMessages(prev => {
                const withoutLoading = prev.filter(msg => !msg.loading);
                const errorMessage = {
                  id: (Date.now() + 2).toString(),
                  type: 'ai',
                  content: 'Sorry, I encountered an error processing your request. Please try again.',
                  timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };
                return [...withoutLoading, errorMessage];
              });
            }

            // Save chat to localStorage
            setTimeout(() => {
              localStorage.setItem(`chat_${currentChatId}`, JSON.stringify(chatMessages));
            }, 100);
          };

          // Prepare chart data from API response
          const chartData = dashboardData?.distributions?.status 
            ? Object.entries(dashboardData.distributions.status).map(([status, count]) => ({
                name: status,
                value: count,
                fill: getStatusColor(status)
              }))
            : [];

          if (loading && !dashboardData) {
            return React.createElement('div', { className: 'flex items-center justify-center h-screen' },
              React.createElement('div', { className: 'flex items-center gap-2' },
                React.createElement(Loader, { className: 'h-5 w-5 animate-spin' }),
                React.createElement('span', null, 'Loading dashboard...')
              )
            );
          }

          return React.createElement('div', { className: 'flex h-screen bg-gray-50' },
            // Sidebar
            React.createElement('div', { 
              className: `fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transform transition-transform duration-300 ease-in-out ${
                isSidebarOpen ? 'translate-x-0' : '-translate-x-full'
              } lg:translate-x-0 lg:static lg:inset-0`
            },
              React.createElement(SidebarComponent, {
                onNavigation: handleNavigation,
                onNewChat: handleNewChat,
                currentPage: currentPage,
                isHistoryOpen: isHistoryOpen,
                setIsHistoryOpen: setIsHistoryOpen,
                chatHistory: chatHistory
              })
            ),

            // Mobile overlay
            isSidebarOpen && React.createElement('div', { 
              className: 'fixed inset-0 z-40 bg-black bg-opacity-50 lg:hidden',
              onClick: () => setIsSidebarOpen(false)
            }),

            // Main content
            React.createElement('div', { className: 'flex-1 flex flex-col overflow-hidden' },
              // Mobile header
              React.createElement('div', { className: 'lg:hidden bg-white shadow-sm px-4 py-3 flex items-center justify-between' },
                React.createElement('button', { 
                  onClick: () => setIsSidebarOpen(true),
                  className: 'p-2'
                }, React.createElement(Menu, { className: 'h-6 w-6' })),
                React.createElement('h1', { className: 'font-semibold text-gray-800' }, 'MAYA - Tone'),
                React.createElement('div', { className: 'w-10' })
              ),

              // Page content
              React.createElement('div', { className: 'flex-1 overflow-auto' },
                currentPage === 'dashboard' && React.createElement(DashboardPage, {
                  data: dashboardData,
                  chartFilter: chartFilter,
                  setChartFilter: setChartFilter,
                  chartData: chartData,
                  onNewChat: handleNewChat,
                  loading: loading,
                  error: error
                }),
                currentPage === 'chat' && React.createElement(ChatPage, {
                  messages: chatMessages,
                  newMessage: newMessage,
                  setNewMessage: setNewMessage,
                  onSendMessage: handleSendMessage
                }),
                currentPage === 'canvas' && React.createElement(CanvasPage, {
                  chartData: chartData,
                  messages: chatMessages,
                  newMessage: newMessage,
                  setNewMessage: setNewMessage,
                  onSendMessage: handleSendMessage
                })
              )
            )
          );
        }

        // Sidebar Component
        function SidebarComponent({ onNavigation, onNewChat, currentPage, isHistoryOpen, setIsHistoryOpen, chatHistory }) {
          return React.createElement('div', { className: 'flex flex-col h-full' },
            // Header
            React.createElement('div', { className: 'p-6 border-b border-gray-200' },
              React.createElement('h1', { className: 'text-xl font-bold text-gray-800' }, 'MAYA - Tone')
            ),

            // New Chat Button
            React.createElement('div', { className: 'p-4' },
              React.createElement('button', {
                onClick: onNewChat,
                className: 'w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors'
              },
                React.createElement(Plus, { className: 'h-4 w-4' }),
                'New Chat'
              )
            ),

            // Navigation
            React.createElement('div', { className: 'flex-1 px-4' },
              React.createElement('div', { className: 'space-y-1' },
                React.createElement('div', { className: 'text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3' }, 'Main'),
                
                React.createElement('button', {
                  onClick: () => onNavigation('dashboard'),
                  className: `w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left transition-colors ${
                    currentPage === 'dashboard' 
                      ? 'bg-blue-100 text-blue-700 font-medium' 
                      : 'text-gray-700 hover:bg-gray-100'
                  }`
                },
                  React.createElement(Home, { className: 'h-4 w-4' }),
                  'Dashboard'
                ),

                React.createElement('button', {
                  onClick: () => onNavigation('canvas'),
                  className: `w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left transition-colors ${
                    currentPage === 'canvas' 
                      ? 'bg-blue-100 text-blue-700 font-medium' 
                      : 'text-gray-700 hover:bg-gray-100'
                  }`
                },
                  React.createElement(Layout, { className: 'h-4 w-4' }),
                  'Canvas'
                )
              ),

              // History Section
              React.createElement('div', { className: 'mt-8' },
                React.createElement('button', {
                  onClick: () => setIsHistoryOpen(!isHistoryOpen),
                  className: 'w-full flex items-center justify-between text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3'
                },
                  'History',
                  isHistoryOpen 
                    ? React.createElement(ChevronDown, { className: 'h-3 w-3' })
                    : React.createElement(ChevronRight, { className: 'h-3 w-3' })
                ),
                
                isHistoryOpen && React.createElement('div', { className: 'space-y-1' },
                  chatHistory.map((chat) =>
                    React.createElement('button', {
                      key: chat.id,
                      onClick: () => onNavigation('chat', chat.id),
                      className: 'w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left text-sm text-gray-700 hover:bg-gray-100 transition-colors'
                    },
                      React.createElement(MessageSquare, { className: 'h-4 w-4' }),
                      chat.title
                    )
                  )
                )
              )
            ),

            // User Profile
            React.createElement('div', { className: 'p-4 border-t border-gray-200' },
              React.createElement('div', { className: 'flex items-center gap-3' },
                React.createElement('div', { className: 'w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center' },
                  React.createElement(User, { className: 'h-4 w-4 text-white' })
                ),
                React.createElement('div', { className: 'flex-1' },
                  React.createElement('div', { className: 'text-sm font-medium text-gray-800' }, 'Kaza Afghanistan'),
                  React.createElement('div', { className: 'text-xs text-gray-500' }, 'Admin')
                )
              )
            )
          );
        }

        // Dashboard Page Component
        function DashboardPage({ data, chartFilter, setChartFilter, chartData, onNewChat, loading, error }) {
          if (error) {
            return React.createElement('div', { className: 'p-6' },
              React.createElement('div', { className: 'bg-red-50 border border-red-200 rounded-lg p-4' },
                React.createElement('div', { className: 'flex items-center gap-2 text-red-800' },
                  React.createElement(XCircle, { className: 'h-5 w-5' }),
                  React.createElement('span', { className: 'font-medium' }, 'Error loading dashboard')
                ),
                React.createElement('p', { className: 'text-red-700 text-sm mt-1' }, error)
              )
            );
          }

          if (!data) {
            return React.createElement('div', { className: 'flex items-center justify-center h-full' },
              React.createElement('div', { className: 'flex items-center gap-2' },
                React.createElement(Loader, { className: 'h-5 w-5 animate-spin' }),
                React.createElement('span', null, 'Loading dashboard data...')
              )
            );
          }

          const statusCards = [
            { title: 'Todo', value: data.distributions?.status?.['To Do'] || 0, color: 'bg-blue-100 text-blue-800', icon: Clock },
            { title: 'Progress', value: data.distributions?.status?.['In Progress'] || 0, color: 'bg-yellow-100 text-yellow-800', icon: Play },
            { title: 'Review', value: data.distributions?.status?.['Review'] || 0, color: 'bg-purple-100 text-purple-800', icon: AlertCircle },
            { title: 'Done', value: data.distributions?.status?.['Done'] || 0, color: 'bg-green-100 text-green-800', icon: CheckCircle },
            { title: 'Bug', value: data.distributions?.status?.['Bug'] || 0, color: 'bg-red-100 text-red-800', icon: XCircle }
          ];

          return React.createElement('div', { className: 'p-6 space-y-6' },
            // Welcome Header
            React.createElement('div', { className: 'flex flex-col sm:flex-row sm:items-center sm:justify-between' },
              React.createElement('div', null,
                React.createElement('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Welcome back, Kaza'),
                React.createElement('p', { className: 'text-gray-600 flex items-center gap-2' },
                  React.createElement(Calendar, { className: 'h-4 w-4' }),
                  new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
                )
              )
            ),

            // Status Cards
            React.createElement('div', { className: 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4' },
              statusCards.map((card, index) => {
                const IconComponent = card.icon;
                return React.createElement('div', { key: index, className: 'bg-white rounded-lg p-6 shadow-sm border border-gray-200' },
                  React.createElement('div', { className: 'flex items-center justify-between' },
                    React.createElement('div', null,
                      React.createElement('p', { className: 'text-sm font-medium text-gray-600' }, card.title),
                      React.createElement('p', { className: 'text-2xl font-bold text-gray-900' }, card.value)
                    ),
                    React.createElement('div', { className: `p-3 rounded-lg ${card.color}` },
                      React.createElement(IconComponent, { className: 'h-5 w-5' })
                    )
                  )
                );
              })
            ),

            // Chart Section
            React.createElement('div', { className: 'bg-white rounded-lg p-6 shadow-sm border border-gray-200' },
              React.createElement('div', { className: 'flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6' },
                React.createElement('h2', { className: 'text-lg font-semibold text-gray-900 flex items-center gap-2' },
                  React.createElement(BarChart3, { className: 'h-5 w-5' }),
                  'Chart by Status'
                ),
                React.createElement('div', { className: 'flex gap-2 mt-3 sm:mt-0' },
                  ['Yearly', 'Monthly', 'Weekly', 'Daily'].map((filter) =>
                    React.createElement('button', {
                      key: filter,
                      onClick: () => setChartFilter(filter),
                      className: `px-3 py-1 rounded text-sm transition-colors ${
                        chartFilter === filter
                          ? 'bg-blue-100 text-blue-700 font-medium'
                          : 'text-gray-600 hover:bg-gray-100'
                      }`
                    }, filter)
                  )
                )
              ),
              
              React.createElement('div', { className: 'h-64' },
                React.createElement(ResponsiveContainer, { width: '100%', height: '100%' },
                  React.createElement(BarChart, { 
                    data: chartData, 
                    margin: { top: 20, right: 30, left: 20, bottom: 5 }
                  },
                    React.createElement(CartesianGrid, { strokeDasharray: '3 3' }),
                    React.createElement(XAxis, { dataKey: 'name' }),
                    React.createElement(YAxis),
                    React.createElement(Tooltip),
                    React.createElement(Bar, { dataKey: 'value', radius: [4, 4, 0, 0] })
                  )
                )
              )
            ),

            // Chat Pane
            React.createElement('div', { className: 'lg:w-1/2 flex flex-col' },
              React.createElement('div', { className: 'p-4 border-b border-gray-200' },
                React.createElement('h2', { className: 'text-lg font-semibold text-gray-900' }, 'Canvas Chat')
              ),
              
              React.createElement('div', { className: 'flex-1 overflow-y-auto p-4 space-y-4' },
                messages.slice(-5).map((message) => // Show only last 5 messages in canvas
                  React.createElement('div', { 
                    key: message.id, 
                    className: `flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`
                  },
                    React.createElement('div', { 
                      className: `flex items-start gap-3 max-w-md ${message.type === 'user' ? 'flex-row-reverse' : 'flex-row'}`
                    },
                      React.createElement('div', { 
                        className: `w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 ${
                          message.type === 'user' ? 'bg-blue-600' : 'bg-gray-600'
                        }`
                      },
                        React.createElement(User, { className: 'h-3 w-3 text-white' })
                      ),
                      React.createElement('div', { 
                        className: `rounded-lg p-3 text-sm ${
                          message.type === 'user' 
                            ? 'bg-blue-600 text-white' 
                            : 'bg-white border border-gray-200'
                        }`
                      },
                        React.createElement('div', { className: 'whitespace-pre-wrap' }, message.content),
                        message.loading && React.createElement(Loader, { className: 'h-3 w-3 animate-spin mt-1' })
                      )
                    )
                  )
                )
              ),

              // Message Input
              React.createElement('div', { className: 'border-t border-gray-200 p-4' },
                React.createElement('form', { onSubmit: onSendMessage, className: 'flex gap-2' },
                  React.createElement('input', {
                    type: 'text',
                    value: newMessage,
                    onChange: (e) => setNewMessage(e.target.value),
                    placeholder: 'Discuss the visualization...',
                    className: 'flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                  }),
                  React.createElement('button', {
                    type: 'submit',
                    disabled: !newMessage.trim(),
                    className: 'bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white p-2 rounded-lg transition-colors'
                  },
                    React.createElement(Send, { className: 'h-4 w-4' })
                  )
                )
              )
            )
          );
        }

        // Utility functions
        function getStatusColor(status) {
          const colors = {
            'To Do': '#3b82f6',
            'In Progress': '#f59e0b', 
            'Review': '#8b5cf6',
            'Done': '#10b981',
            'Bug': '#ef4444'
          };
          return colors[status] || '#6b7280';
        }

        function getStatusBadgeColor(status) {
          const colors = {
            'To Do': 'bg-blue-100 text-blue-800',
            'In Progress': 'bg-yellow-100 text-yellow-800',
            'Review': 'bg-purple-100 text-purple-800', 
            'Done': 'bg-green-100 text-green-800',
            'Bug': 'bg-red-100 text-red-800'
          };
          return colors[status] || 'bg-gray-100 text-gray-800';
        }

        // Render the app
        ReactDOM.render(React.createElement(MayaToneDashboard), document.getElementById('root'));
    </script>
</body>
</html>